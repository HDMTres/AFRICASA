name: ğŸš€ Deploy to Azure Container Registry

on:
  push:
    branches: [ ci ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY_NAME: 'africasaregistry'  # Remplacez par votre nom de registry
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ğŸ§ª Tests (reprise de votre CI existante)
  test:
    name: ğŸ§ª Testsss
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd backend && npm install
        cd ../frontend && npm install

    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Testing backend..."
        cd backend && npm run test --if-present || echo "No tests configured for backend"
        echo "ğŸ§ª Testing frontend..."
        cd ../frontend && npm run test --if-present || echo "No tests configured for frontend"

  # ğŸ³ Build and Push to ACR
  build-and-push:
    name: ğŸ³ Build & Push to ACR
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ci'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.ARM_CLIENT_ID }}",
            "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.ARM_TENANT_ID }}"
          }

    - name: ğŸ—ï¸ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}

    - name: ğŸ³ Build and Push Backend Image
      run: |
        cd backend
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-backend:${{ env.IMAGE_TAG }} .
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-backend:latest .
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-backend:${{ env.IMAGE_TAG }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-backend:latest
        echo "âœ… Backend image pushed successfully"

    - name: ğŸ³ Build and Push Frontend Image
      run: |
        cd frontend
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-frontend:${{ env.IMAGE_TAG }} .
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-frontend:latest .
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-frontend:${{ env.IMAGE_TAG }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-frontend:latest
        echo "âœ… Frontend image pushed successfully"

    - name: ğŸ³ Build and Push MongoDB Image (if needed)
      run: |
        # Si vous avez un Dockerfile personnalisÃ© pour MongoDB
        # Sinon, utilisez l'image officielle mongo:latest
        docker pull mongo:latest
        docker tag mongo:latest ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-mongodb:latest
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/africasa-mongodb:latest
        echo "âœ… MongoDB image pushed successfully"

    - name: ğŸ“Š Show pushed images
      run: |
        echo "ğŸ‰ Images pushed to ACR:"
        az acr repository list --name ${{ env.REGISTRY_NAME }} --output table
        echo "ğŸ”— Registry URL: https://${{ env.REGISTRY_NAME }}.azurecr.io"

  # ğŸ¯ Deploy notification
  deploy-notification:
    name: ğŸ¯ Deploy Notification
    runs-on: ubuntu-latest
    needs: [test, build-and-push]
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.build-and-push.result == 'success'
      run: |
        echo "ğŸ‰ AFRICASA deployment completed successfully!"
        echo "âœ… Tests passed"
        echo "âœ… Images built and pushed to ACR"
        echo "ğŸš€ Ready for production deployment!"
        echo "ğŸ”— Registry: https://${{ env.REGISTRY_NAME }}.azurecr.io"

    - name: âŒ Failure notification
      if: needs.build-and-push.result == 'failure'
      run: |
        echo "âŒ AFRICASA deployment failed!"
        echo "ğŸ” Check the logs above for details"
        exit 1
